<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>OSSL_PARAM_allocate_from_text</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rev="made" href="mailto:" />
</head>

<body>



<ul id="index">
  <li><a href="#NAME">NAME</a></li>
  <li><a href="#SYNOPSIS">SYNOPSIS</a></li>
  <li><a href="#DESCRIPTION">DESCRIPTION</a>
    <ul>
      <li><a href="#The-use-of-key-and-value-in-detail">The use of key and value in detail</a></li>
    </ul>
  </li>
  <li><a href="#RETURN-VALUES">RETURN VALUES</a></li>
  <li><a href="#NOTES">NOTES</a></li>
  <li><a href="#EXAMPLES">EXAMPLES</a></li>
  <li><a href="#SEE-ALSO">SEE ALSO</a></li>
  <li><a href="#COPYRIGHT">COPYRIGHT</a></li>
</ul>

<h1 id="NAME">NAME</h1>

<p>OSSL_PARAM_allocate_from_text - OSSL_PARAM construction utilities</p>

<h1 id="SYNOPSIS">SYNOPSIS</h1>

<pre><code> <span class="comment">#include &lt;openssl/params.h&gt;</span>
 
 <span class="keyword">int</span> <span class="variable">OSSL_PARAM_allocate_from_text</span><span class="operator">(</span><span class="variable">OSSL_PARAM</span> <span class="variable">*to</span><span class="operator">,</span>
                                   <span class="variable">const</span> <span class="variable">OSSL_PARAM</span> <span class="variable">*paramdefs</span><span class="operator">,</span>
                                   <span class="variable">const</span> <span class="variable">char</span> <span class="variable">*key</span><span class="operator">,</span> <span class="variable">const</span> <span class="variable">char</span> <span class="variable">*value</span><span class="operator">,</span>
                                   <span class="variable">size_t</span> <span class="variable">value_n</span><span class="operator">,</span>
                                   <span class="keyword">int</span> <span class="variable">*found</span><span class="operator">);</span>
</code></pre>

<h1 id="DESCRIPTION">DESCRIPTION</h1>

<p>With OpenSSL before version 3.0, parameters were passed down to or retrieved from algorithm implementations via control functions. Some of these control functions existed in variants that took string parameters, for example <a href="../man3/EVP_PKEY_CTX_ctrl_str.html">EVP_PKEY_CTX_ctrl_str(3)</a>.</p>

<p>OpenSSL 3.0 introduces a new mechanism to do the same thing with an array of parameters that contain name, value, value type and value size (see <a href="../man3/OSSL_PARAM.html">OSSL_PARAM(3)</a> for more information).</p>

<p>OSSL_PARAM_allocate_from_text() uses <i>key</i> to look up an item in <i>paramdefs</i>. If an item was found, it converts <i>value</i> to something suitable for that item&#39;s <i>data_type</i>, and stores the result in <i>to-&gt;data</i> as well as its size in <i>to-&gt;data_size</i>. <i>to-&gt;key</i> and <i>to-&gt;data_type</i> are assigned the corresponding values from the item that was found, and <i>to-&gt;return_size</i> is set to zero.</p>

<p><i>to-&gt;data</i> is always allocated using <a href="../man3/OPENSSL_zalloc.html">OPENSSL_zalloc(3)</a> and needs to be freed by the caller when it&#39;s not useful any more, using <a href="../man3/OPENSSL_free.html">OPENSSL_free(3)</a>.</p>

<p>If <i>found</i> is not NULL, <i>*found</i> is set to 1 if <i>key</i> could be located in <i>paramdefs</i>, and to 0 otherwise.</p>

<h2 id="The-use-of-key-and-value-in-detail">The use of <i>key</i> and <i>value</i> in detail</h2>

<p>OSSL_PARAM_allocate_from_text() takes note if <i>key</i> starts with &quot;hex&quot;, and will only use the rest of <i>key</i> to look up an item in <i>paramdefs</i> in that case. As an example, if <i>key</i> is &quot;hexid&quot;, &quot;id&quot; will be looked up in <i>paramdefs</i>.</p>

<p>When an item in <i>paramdefs</i> has been found, <i>value</i> is converted depending on that item&#39;s <i>data_type</i>, as follows:</p>

<dl>

<dt id="OSSL_PARAM_INTEGER-and-OSSL_PARAM_UNSIGNED_INTEGER"><b>OSSL_PARAM_INTEGER</b> and <b>OSSL_PARAM_UNSIGNED_INTEGER</b></dt>
<dd>

<p>If <i>key</i> didn&#39;t start with &quot;hex&quot;, <i>value</i> is assumed to contain <i>value_n</i> decimal characters, which are decoded, and the resulting bytes become the number stored in the <i>to-&gt;data</i> storage.</p>

<p>If <i>value</i> starts with &quot;0x&quot;, it is assumed to contain <i>value_n</i> hexadecimal characters.</p>

<p>If <i>key</i> started with &quot;hex&quot;, <i>value</i> is assumed to contain <i>value_n</i> hexadecimal characters without the &quot;0x&quot; prefix.</p>

<p>If <i>value</i> contains characters that couldn&#39;t be decoded as hexadecimal or decimal characters, OSSL_PARAM_allocate_from_text() considers that an error.</p>

</dd>
<dt id="OSSL_PARAM_UTF8_STRING"><b>OSSL_PARAM_UTF8_STRING</b></dt>
<dd>

<p>If <i>key</i> started with &quot;hex&quot;, OSSL_PARAM_allocate_from_text() considers that an error.</p>

<p>Otherwise, <i>value</i> is considered a C string and is copied to the <i>to-&gt;data</i> storage. On systems where the native character encoding is EBCDIC, the bytes in <i>to-&gt;data</i> are converted to ASCII.</p>

</dd>
<dt id="OSSL_PARAM_OCTET_STRING"><b>OSSL_PARAM_OCTET_STRING</b></dt>
<dd>

<p>If <i>key</i> started with &quot;hex&quot;, <i>value</i> is assumed to contain <i>value_n</i> hexadecimal characters, which are decoded, and the resulting bytes are stored in the <i>to-&gt;data</i> storage. If <i>value</i> contains characters that couldn&#39;t be decoded as hexadecimal or decimal characters, OSSL_PARAM_allocate_from_text() considers that an error.</p>

<p>If <i>key</i> didn&#39;t start with &quot;hex&quot;, <i>value_n</i> bytes from <i>value</i> are copied to the <i>to-&gt;data</i> storage.</p>

</dd>
</dl>

<h1 id="RETURN-VALUES">RETURN VALUES</h1>

<p>OSSL_PARAM_allocate_from_text() returns 1 if <i>key</i> was found in <i>paramdefs</i> and there was no other failure, otherwise 0.</p>

<h1 id="NOTES">NOTES</h1>

<p>The parameter descriptor array comes from functions dedicated to return them. The following <a href="../man3/OSSL_PARAM.html">OSSL_PARAM(3)</a> attributes are used:</p>

<dl>

<dt id="key"><i>key</i></dt>
<dd>

</dd>
<dt id="data_type"><i>data_type</i></dt>
<dd>

</dd>
<dt id="data_size"><i>data_size</i></dt>
<dd>

</dd>
</dl>

<p>All other attributes are ignored.</p>

<p>The <i>data_size</i> attribute can be zero, meaning that the parameter it describes expects arbitrary length data.</p>

<h1 id="EXAMPLES">EXAMPLES</h1>

<p>Code that looked like this:</p>

<pre><code>  <span class="keyword">int</span> <span class="variable">mac_ctrl_string</span><span class="operator">(</span><span class="variable">EVP_PKEY_CTX</span> <span class="variable">*ctx</span><span class="operator">,</span> <span class="variable">const</span> <span class="variable">char</span> <span class="variable">*value</span><span class="operator">)</span>
  <span class="operator">{</span>
      <span class="keyword">int</span> <span class="variable">rv</span><span class="operator">;</span>
      <span class="variable">char</span> <span class="variable">*stmp</span><span class="operator">,</span> <span class="variable">*vtmp</span> <span class="operator">=</span> <span class="variable">NULL</span><span class="operator">;</span>
  
      <span class="variable">stmp</span> <span class="operator">=</span> <span class="variable">OPENSSL_strdup</span><span class="operator">(</span><span class="variable">value</span><span class="operator">);</span>
      <span class="keyword">if</span> <span class="operator">(</span><span class="variable">stmp</span> <span class="operator">==</span> <span class="variable">NULL</span><span class="operator">)</span>
          <span class="keyword">return</span> <span class="operator">-</span><span class="number">1</span><span class="operator">;</span>
      <span class="variable">vtmp</span> <span class="operator">=</span> <span class="variable">strchr</span><span class="operator">(</span><span class="variable">stmp</span><span class="operator">,</span> <span class="string">':'</span><span class="operator">);</span>
      <span class="keyword">if</span> <span class="operator">(</span><span class="variable">vtmp</span> <span class="operator">!=</span> <span class="variable">NULL</span><span class="operator">)</span>
          <span class="variable">*vtmp</span><span class="operator">++</span> <span class="operator">=</span> <span class="string">'\0'</span><span class="operator">;</span>
      <span class="variable">rv</span> <span class="operator">=</span> <span class="variable">EVP_MAC_ctrl_str</span><span class="operator">(</span><span class="variable">ctx</span><span class="operator">,</span> <span class="variable">stmp</span><span class="operator">,</span> <span class="variable">vtmp</span><span class="operator">);</span>
      <span class="variable">OPENSSL_free</span><span class="operator">(</span><span class="variable">stmp</span><span class="operator">);</span>
      <span class="keyword">return</span> <span class="variable">rv</span><span class="operator">;</span>
  <span class="operator">}</span>
  
  <span class="operator">...</span>
  
  
  <span class="keyword">for</span> <span class="operator">(</span><span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span> <span class="variable">i</span> <span class="operator">&lt;</span> <span class="variable">sk_OPENSSL_STRING_num</span><span class="operator">(</span><span class="variable">macopts</span><span class="operator">);</span> <span class="variable">i</span><span class="operator">++)</span> <span class="operator">{</span>
      <span class="variable">char</span> <span class="variable">*macopt</span> <span class="operator">=</span> <span class="variable">sk_OPENSSL_STRING_value</span><span class="operator">(</span><span class="variable">macopts</span><span class="operator">,</span> <span class="variable">i</span><span class="operator">);</span>
  
      <span class="keyword">if</span> <span class="operator">(</span><span class="variable">pkey_ctrl_string</span><span class="operator">(</span><span class="variable">mac_ctx</span><span class="operator">,</span> <span class="variable">macopt</span><span class="operator">)</span> <span class="operator">&lt;=</span> <span class="number">0</span><span class="operator">)</span> <span class="operator">{</span>
          <span class="variable">BIO_printf</span><span class="operator">(</span><span class="variable">bio_err</span><span class="operator">,</span>
                     <span class="string">"MAC parameter error \"%s\"\n"</span><span class="operator">,</span> <span class="variable">macopt</span><span class="operator">);</span>
          <span class="variable">ERR_print_errors</span><span class="operator">(</span><span class="variable">bio_err</span><span class="operator">);</span>
          <span class="keyword">goto</span> <span class="variable">mac_end</span><span class="operator">;</span>
      <span class="operator">}</span>
  <span class="operator">}</span>
</code></pre>

<p>Can be written like this instead:</p>

<pre><code>  <span class="variable">OSSL_PARAM</span> <span class="variable">*params</span> <span class="operator">=</span>
      <span class="variable">OPENSSL_zalloc</span><span class="operator">(</span><span class="variable">sizeof</span><span class="operator">(</span><span class="variable">*params</span><span class="operator">)</span>
                     <span class="operator">*</span> <span class="operator">(</span><span class="variable">sk_OPENSSL_STRING_num</span><span class="operator">(</span><span class="variable">opts</span><span class="operator">)</span> <span class="operator">+</span> <span class="number">1</span><span class="operator">));</span>
  <span class="variable">const</span> <span class="variable">OSSL_PARAM</span> <span class="variable">*paramdefs</span> <span class="operator">=</span> <span class="variable">EVP_MAC_settable_ctx_params</span><span class="operator">(</span><span class="variable">mac</span><span class="operator">);</span>
  <span class="variable">size_t</span> <span class="variable">params_n</span><span class="operator">;</span>
  <span class="variable">char</span> <span class="variable">*opt</span> <span class="operator">=</span> <span class="string">"&lt;unknown&gt;"</span><span class="operator">;</span>
  
  <span class="keyword">for</span> <span class="operator">(</span><span class="variable">params_n</span> <span class="operator">=</span> <span class="number">0</span><span class="operator">;</span> <span class="variable">params_n</span> <span class="operator">&lt;</span> <span class="operator">(</span><span class="variable">size_t</span><span class="operator">)</span><span class="variable">sk_OPENSSL_STRING_num</span><span class="operator">(</span><span class="variable">opts</span><span class="operator">);</span>
       <span class="variable">params_n</span><span class="operator">++)</span> <span class="operator">{</span>
      <span class="variable">char</span> <span class="variable">*stmp</span><span class="operator">,</span> <span class="variable">*vtmp</span> <span class="operator">=</span> <span class="variable">NULL</span><span class="operator">;</span>
  
      <span class="variable">opt</span> <span class="operator">=</span> <span class="variable">sk_OPENSSL_STRING_value</span><span class="operator">(</span><span class="variable">opts</span><span class="operator">,</span> <span class="operator">(</span><span class="keyword">int</span><span class="operator">)</span><span class="variable">params_n</span><span class="operator">);</span>
      <span class="keyword">if</span> <span class="operator">((</span><span class="variable">stmp</span> <span class="operator">=</span> <span class="variable">OPENSSL_strdup</span><span class="operator">(</span><span class="variable">opt</span><span class="operator">))</span> <span class="operator">==</span> <span class="variable">NULL</span>
              <span class="operator">||</span> <span class="operator">(</span><span class="variable">vtmp</span> <span class="operator">=</span> <span class="variable">strchr</span><span class="operator">(</span><span class="variable">stmp</span><span class="operator">,</span> <span class="string">':'</span><span class="operator">))</span> <span class="operator">==</span> <span class="variable">NULL</span><span class="operator">)</span>
          <span class="keyword">goto</span> <span class="variable">err</span><span class="operator">;</span>
  
      <span class="variable">*vtmp</span><span class="operator">++</span> <span class="operator">=</span> <span class="string">'\0'</span><span class="operator">;</span>
      <span class="keyword">if</span> <span class="operator">(!</span><span class="variable">OSSL_PARAM_allocate_from_text</span><span class="operator">(&amp;</span><span class="variable">params</span><span class="operator">[</span><span class="variable">params_n</span><span class="operator">]</span><span class="operator">,</span>
                                         <span class="variable">paramdefs</span><span class="operator">,</span> <span class="variable">stmp</span><span class="operator">,</span>
                                         <span class="variable">vtmp</span><span class="operator">,</span> <span class="variable">strlen</span><span class="operator">(</span><span class="variable">vtmp</span><span class="operator">),</span> <span class="variable">NULL</span><span class="operator">))</span>
          <span class="keyword">goto</span> <span class="variable">err</span><span class="operator">;</span>
  <span class="operator">}</span>
  <span class="variable">params</span><span class="operator">[</span><span class="variable">params_n</span><span class="operator">]</span> <span class="operator">=</span> <span class="variable">OSSL_PARAM_construct_end</span><span class="operator">();</span>
  <span class="keyword">if</span> <span class="operator">(!</span><span class="variable">EVP_MAC_CTX_set_params</span><span class="operator">(</span><span class="variable">ctx</span><span class="operator">,</span> <span class="variable">params</span><span class="operator">))</span>
      <span class="keyword">goto</span> <span class="variable">err</span><span class="operator">;</span>
  <span class="keyword">while</span> <span class="operator">(</span><span class="variable">params_n</span><span class="operator">--</span> <span class="operator">&gt;</span> <span class="number">0</span><span class="operator">)</span>
      <span class="variable">OPENSSL_free</span><span class="operator">(</span><span class="variable">params</span><span class="operator">[</span><span class="variable">params_n</span><span class="operator">]</span><span class="operator">.</span><span class="variable">data</span><span class="operator">);</span>
  <span class="variable">OPENSSL_free</span><span class="operator">(</span><span class="variable">params</span><span class="operator">);</span>
  <span class="regex">/* ... */</span>
  <span class="keyword">return</span><span class="operator">;</span>
  
   <span class="variable">err</span><span class="operator">:</span>
  <span class="variable">BIO_printf</span><span class="operator">(</span><span class="variable">bio_err</span><span class="operator">,</span> <span class="string">"MAC parameter error '%s'\n"</span><span class="operator">,</span> <span class="variable">opt</span><span class="operator">);</span>
  <span class="variable">ERR_print_errors</span><span class="operator">(</span><span class="variable">bio_err</span><span class="operator">);</span>
</code></pre>

<h1 id="SEE-ALSO">SEE ALSO</h1>

<p><a href="../man3/OSSL_PARAM.html">OSSL_PARAM(3)</a>, <a href="../man3/OSSL_PARAM_int.html">OSSL_PARAM_int(3)</a></p>

<h1 id="COPYRIGHT">COPYRIGHT</h1>

<p>Copyright 2019-2021 The OpenSSL Project Authors. All Rights Reserved.</p>

<p>Licensed under the Apache License 2.0 (the &quot;License&quot;). You may not use this file except in compliance with the License. You can obtain a copy in the file LICENSE in the source distribution or at <a href="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</a>.</p>


</body>

</html>


